# 3-b. Copilot Studio + Azure 클라우드 배포 가이드 (ACR + ACA)

이 가이드는 로컬 서버의 한계를 넘어, Azure Container Registry(ACR)와 Container Apps(ACA)를 활용해 MCP 서버를 클라우드에 배포하고 상시 가동 환경을 구축하는 전체 과정을 다룹니다.

## 사전 요구사항 (Prerequisites)

* **Azure 구독:** 리소스 생성이 가능한 권한 필요
* **Azure CLI:** 터미널 로그인 상태 (`az login`)
* **프로젝트 파일:** `server.py`, `Dockerfile`

---

## 1. Azure 컨테이너 레지스트리(ACR) 생성 및 설정

배포용 이미지를 저장할 우리 팀만의 전용 저장소를 Azure Portal에서 생성합니다.

### 1.1 ACR 리소스 생성

1. **Azure Portal** 접속 후 '컨테이너 레지스트리' 검색 및 생성.
2. **이름:** 전역 고유 이름 (예: `mcp001`) / **지역:** `Korea Central` / **SKU:** `Basic`.
3. **관리자 계정 활성화 (필수):** * 생성된 ACR 리소스로 이동 -> 왼쪽 메뉴 **[액세스 키]** 클릭.
* **'관리자 사용자'** 항목을 활성화(Enabled)로 변경합니다. (이 설정을 해야 Container Apps가 이미지를 가져올 수 있습니다.)

---

## 2. 클라우드 최적화 서버 구성 (코드 및 도커)

Azure의 리버스 프록시와 보안 환경을 통과하기 위해 최적화된 최종 소스 코드입니다.

### 2.1 서버 메인 코드 (`server.py`)

```python
import os
import uvicorn
from uvicorn import Config

# [1] Uvicorn 엔진 몽키 패치 (0.0.0.0 바인딩 및 프록시 헤더 신뢰)
original_run = uvicorn.run
original_config_init = Config.__init__

def patched_run(app, **kwargs):
    kwargs['host'] = '0.0.0.0'
    kwargs['port'] = int(os.environ.get("PORT", kwargs.get('port', 8000)))
    kwargs['proxy_headers'] = True
    kwargs['forwarded_allow_ips'] = '*'
    return original_run(app, **kwargs)

def patched_config_init(self, app, **kwargs):
    kwargs['host'] = '0.0.0.0'
    kwargs['port'] = int(os.environ.get("PORT", kwargs.get('port', 8000)))
    kwargs['proxy_headers'] = True
    kwargs['forwarded_allow_ips'] = '*'
    kwargs['server_header'] = False
    return original_config_init(self, app, **kwargs)

uvicorn.run = patched_run
Config.__init__ = patched_config_init

# [2] MCP 라이브러리 및 보안 설정 (Invalid Host Header 해결)
from mcp.server.fastmcp import FastMCP
from mcp.server.streamable_http import TransportSecuritySettings

security_settings = TransportSecuritySettings(
    allowed_hosts=["*"],  # 모든 호스트 허용
    enable_dns_rebinding_protection=False
)

mcp = FastMCP("Calculator", transport_security=security_settings)

@mcp.tool(description="Add two numbers.")
def add(a: float, b: float) -> float: return a + b

@mcp.tool(description="Subtract b from a.")
def subtract(a: float, b: float) -> float: return a - b

@mcp.tool(description="Multiply two numbers.")
def multiply(a: float, b: float) -> float: return a * b

@mcp.tool(description="Divide a by b.")
def divide(a: float, b: float) -> float:
    if b == 0: raise ValueError("Cannot divide by zero")
    return a / b

if __name__ == "__main__":
    mcp.run(transport="streamable-http")

```

### 2.2 컨테이너 설정 (`Dockerfile`)

```dockerfile
FROM python:3.11-slim
WORKDIR /app
RUN pip install --no-cache-dir "mcp[cli]" uvicorn
COPY . .
EXPOSE 8000
CMD ["python", "server.py"]

```

---

## 3. 이미지 빌드 및 배포 (Build & Deployment)

### 3.1 ACR 클라우드 빌드

로컬 도커 없이 아래 명령어로 이미지를 빌드하여 ACR에 바로 저장합니다.

```powershell
# ACR 이름이 'mcp001'인 경우
az acr build --registry mcp001 --image mcp-calculator:latest .

```

### 3.2 Azure Container Apps (ACA) 생성

1. **Azure Portal**에서 '컨테이너 앱' 검색 및 생성.
2. **컨테이너 이미지 설정:** * 이미지 원본을 `Azure Container Registry`로 선택하고, 위에서 빌드한 이미지를 지정합니다.
3. **수신(Ingress) 설정 (매우 중요):**
* **수신:** 활성화 / **수신 트래픽:** 모든 곳에서 수락.
* **대상 포트:** **`8000`** 입력.



---

## 4. Copilot Studio 최종 연동

1. **URL 확인:** ACA [개요] 페이지의 '애플리케이션 URL'을 복사합니다.
2. **도구 추가:** Copilot Studio -> [Settings] -> [Tools] -> [Add Tool] -> [MCP] 선택.
3. **Endpoint 설정:** 복사한 URL 뒤에 반드시 `/mcp`를 추가합니다.
* `https://mcp-app.azurecontainerapps.io/mcp`


4. **인증:** `None` 선택 후 연결 완료.

---

## 해결된 주요 트러블슈팅

* **네트워크 바인딩:** 컨테이너 환경에 필수적인 `0.0.0.0` 바인딩을 몽키 패치로 강제 적용.
* **421 Misdirected Request:** `TransportSecuritySettings`를 통해 Azure 프록시 도메인 검증 통과.
* **Invalid Host Header:** `proxy_headers` 및 `forwarded_allow_ips` 설정으로 리버프 프록시 환경 대응.

---
