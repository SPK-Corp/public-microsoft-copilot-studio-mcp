# 3-a. Copilot Studio + Local MCP 서버 연동 가이드 (Windows + ngrok)

이 가이드는 Windows 환경에서 Python 가상환경(venv)을 활용하여 **시스템 환경과 격리된 상태로** MCP 서버를 구축한 뒤, **ngrok**을 통해 외부에 공개하여 **Copilot Studio** 에이전트와 연동하는 전체 과정을 다룹니다.

> **이 실습의 특징:** ngrok 실행 파일부터 Python 라이브러리까지 모든 리소스를 **하나의 실습용 폴더** 내에서만 관리하므로, 실습 후 폴더만 삭제하면 시스템을 깨끗하게 유지할 수 있습니다.

## 사전 요구사항 (Prerequisites)

* **OS:** Windows 10/11
* **필수 도구:**
* [Python 3.10 이상](https://www.python.org/downloads/) (**설치 시 반드시 'Add Python to PATH' 체크**)
* [Visual Studio Code](https://code.visualstudio.com/)


* **계정:**
* Microsoft Copilot Studio 접근 권한
* [ngrok](https://ngrok.com/) 계정 (무료 회원가입 필요)



---

## 1. ngrok 준비 (회원가입 및 설정)

ngrok은 로컬 서버를 외부 인터넷망에서 접속할 수 있도록 보안 터널을 생성하는 도구입니다.

### 1.1 회원가입 및 토큰 확인

1. [ngrok 대시보드](https://dashboard.ngrok.com/signup)에 접속하여 회원가입 및 로그인을 진행합니다.
2. 대시보드 왼쪽 메뉴에서 [Getting Started] -> [Your Authtoken]을 클릭합니다.
3. 화면에 표시된 **Authtoken** 값을 복사해 둡니다. (터널 인증에 필수)

![alt text](img/3-a-01.png)

### 1.2 ngrok 다운로드 및 배치

1. [Download 페이지](https://ngrok.com/download)에서 **Windows용 zip 파일**을 다운로드합니다.
2. 바탕화면이나 문서 폴더에 실습용 폴더(예: `McpDemo`)를 생성합니다.
3. 압축 파일 내의 **`ngrok.exe` 파일만 추출하여 `McpDemo` 폴더 안에 저장**합니다.

![alt text](img/3-a-02.png)
![alt text](img/3-a-03.png)

---

## 2. 프로젝트 격리 환경 구성 (venv)

Windows 시스템 전역 설정을 변경하지 않고, 해당 프로젝트 폴더 내부에만 라이브러리를 설치하기 위해 가상환경을 구성합니다.

### 2.1 VS Code 실행 및 터미널 열기

1. VS Code를 실행하고 [파일] -> [폴더 열기]를 통해 `McpDemo` 폴더를 엽니다.
2. 상단 메뉴 [터미널(Terminal)] -> [새 터미널(New Terminal)]을 클릭합니다.

![alt text](img/3-a-04.png)

### 2.2 가상환경(venv) 생성 및 활성화

터미널(PowerShell)에 아래 명령어를 순서대로 입력하여 독립된 Python 환경을 생성합니다.

```powershell
# 1. 가상환경 생성 (.venv 폴더 생성)
py -m venv .venv

# 2. 가상환경 활성화 (명령어 프롬프트 앞에 (.venv) 표시 생성)
.\.venv\Scripts\activate

```

> **참고:** 보안 오류 발생 시 `Set-ExecutionPolicy Unrestricted -Scope Process` 입력 후 `Y`를 눌러 승인합니다.

![alt text](img/3-a-05.png)
![alt text](img/3-a-06.png)

### 2.3 필수 라이브러리 설치

가상환경이 활성화된 상태(`(.venv)`)에서 MCP 서버 구동 패키지를 설치합니다.

```powershell
pip install "mcp[cli]" uvicorn

```

---

## 3. Python MCP 서버 구현

### 3.1 서버 코드 작성 (server.py)

VS Code 탐색기 빈 공간을 우클릭하여 `server.py` 파일을 생성하고, 아래 표준 코드를 붙여넣습니다.

```python
from mcp.server.fastmcp import FastMCP

# 1. 서버 이름 정의
mcp = FastMCP("Calculator")

# --- 도구(Tools) 정의 ---
# description은 AI가 도구를 선택하는 핵심 기준입니다.

@mcp.tool(description="Add two numbers together. (Example: 10 + 20)")
def add(a: float, b: float) -> float:
    return a + b

@mcp.tool(description="Subtract b from a. (Example: 50 - 10)")
def subtract(a: float, b: float) -> float:
    return a - b

@mcp.tool(description="Multiply two numbers. Used for area calculation, etc.")
def multiply(a: float, b: float) -> float:
    return a * b

@mcp.tool(description="Divide a by b. Raises error if dividing by zero.")
def divide(a: float, b: float) -> float:
    if b == 0:
        raise ValueError("Cannot divide by zero")
    return a / b

# --- 서버 실행 설정 ---
if __name__ == "__main__":
    # Copilot Studio 호환을 위해 'streamable-http' 전송 방식 사용
    mcp.run(transport="streamable-http")

```

![alt text](img/3-a-07.png)

### 3.2 서버 실행

터미널에서 서버를 구동합니다. (이 터미널은 끄지 않고 유지합니다.)

```powershell
python server.py

```

![alt text](img/3-a-08.png)

---

## 4. ngrok 실행 및 퍼블릭 URL 확보

### 4.1 ngrok 인증 및 터널링

VS Code 우측 상단 `+` 버튼(터미널 추가)을 눌러 **새 터미널**을 열고 명령어를 입력합니다.

```powershell
# 1. 인증 토큰 등록 (최초 1회 필수, 1.1단계의 토큰 사용)
.\ngrok config add-authtoken <여기에_복사한_토큰_붙여넣기>

# 2. 로컬 8000번 포트를 외부로 공개
.\ngrok http 8000 --host-header=rewrite

```

![alt text](img/3-a-09.png)

### 4.2 퍼블릭 URL 복사

실행 화면의 **Forwarding** 항목에 표시된 `https` 주소를 복사합니다.

* **예시:** `https://1a2b-3c4d.ngrok-free.app`

![alt text](img/3-a-10.png)

---

## 5. Copilot Studio 에이전트 생성

### 5.1 새 에이전트 만들기

[Copilot Studio](https://copilotstudio.microsoft.com/)에 접속하여 실습용 에이전트를 생성합니다.

* **이름:** MCP Calculator (ngrok)
* **설명:** Math agent powered by local Python MCP server.

![alt text](img/3-a-11.png)
![alt text](img/3-a-12.png)
![alt text](img/3-a-13.png)

---

## 6. MCP 도구 연결 (Integration)

### 6.1 도구 추가

1. 상단 메뉴 **[설정 (Settings)]** -> **[도구 (Tools)]** 탭으로 이동합니다.
2. **[+ 도구 추가 (+ Add tool)]** 버튼 클릭 -> **[MCP (Model Context Protocol)]** 선택.

![alt text](img/3-a-14.png)
![alt text](img/3-a-15.png)
![alt text](img/3-a-16.png)

### 6.2 서버 URL 설정

복사해둔 ngrok URL 뒤에 반드시 **/mcp** 경로를 추가하여 입력합니다.

* **서버 URL:** `https://<내-ngrok-주소>.ngrok-free.app/mcp`
* **인증:** 없음 (No authentication)

![alt text](img/3-a-17.png)
![alt text](img/3-a-18.png)
![alt text](img/3-a-19.png)
![alt text](img/3-a-20.png)
![alt text](img/3-a-21.png)

### 6.3 도구 등록 완료

`add`, `subtract` 등의 함수 목록이 정상적으로 로딩되는 것을 확인할 수 있습니다.

![alt text](img/3-a-22.png)

---

## 7. 기능 테스트 및 검증

### 7.1 추적 모드 활성화

우측 **[에이전트 테스트 (Test your agent)]** 패널을 열고, 상단의 [지도 아이콘 (Tracing)]을 켜서 로그 추적 기능을 활성화합니다.

![alt text](img/3-a-23.png)

### 7.2 연결 승인

채팅창에 "10 더하기 20은?"이라고 입력합니다.

1. **[​Open connection manager]** 버튼을 클릭합니다.
2. 이후 연결이 필요하다면 [허용 (Allow)]을 클릭하여 도구 사용을 승인합니다.

![alt text](img/3-a-24.png)
![alt text](img/3-a-25.png)
![alt text](img/3-a-26.png)
![alt text](img/3-a-27.png)

### 7.3 결과 확인

연결이 완료되면 에이전트가 Python 서버를 호출하여 정확한 계산 결과를 반환합니다.

* **답변:** "10 plus 20 equals 30."

![alt text](img/3-a-28.png)

### 7.4 MCP 도구 확장 아이디어

지금까지는 단순 계산 예제로만 확인했지만, MCP의 강점은 **여러 도구를 조합해서 더 복잡한 작업을 자동화**할 수 있다는 점입니다. 아래와 같은 방향으로 서버 코드를 확장해 보면서, Copilot Studio 에이전트에게 다양한 "미션"을 던져볼 수 있습니다.

1. **여러 연산을 한 번에 수행하는 시나리오**  
    * 예: "100에서 30을 빼고, 남은 값에 2를 곱한 다음, 그 결과를 5로 나눠줘."  
    * 에이전트가 `subtract` → `multiply` → `divide` 순서로 **여러 도구 호출을 자동으로 설계**하는지 추적(Tracing)으로 확인해 볼 수 있습니다.

    ![alt text](img/3-a-29.png)

2. **설명까지 요구하는 질문**  
    * 예: "10 더하기 20을 계산하고, 왜 그런 결과가 나오는지 초등학생 수준으로 설명해 줘."  
    * MCP 도구는 숫자 계산만 담당하고, **설명 문장은 LLM이 생성**합니다. 계산과 자연어 설명이 **어떻게 역할 분담**되는지를 관찰해 보세요.

    ![alt text](img/3-a-30.png)

3. **오류 처리/엣지 케이스 실험**  
    * 예: "10을 0으로 나누면 어떻게 돼?"  
    * `divide` 도구에서 0으로 나누기 시 `ValueError`를 발생시키도록 구현되어 있으므로, Copilot Studio 쪽에서는 **에러 메시지를 어떻게 사용자 친화적으로 바꿔서 보여주는지** 확인할 수 있습니다.

    ![alt text](img/3-a-31.png)

4. **새로운 도구를 추가한 뒤 연결해 보기**  
    * 서버 코드에 아래와 같은 도구를 직접 추가해 볼 수 있습니다.  
      * "원의 넓이 계산 (반지름 r를 받아 πr² 계산)"  
      * "섭씨/화씨 온도 변환"  
    * 그런 다음 에이전트에게  
      * "반지름 10인 원의 넓이를 구해줘."  
      * "오늘 기온 30도를 화씨로 바꾸면 몇 도야?"  
      와 같이 질문하면서, **새 도구가 정상적으로 노출·호출되는지** 추적해 보세요.

5. **현실적인 업무 시나리오로 확장**  
    * 계산기 대신, 실제 업무에서 쓸만한 간단한 도구로 바꿔보는 것도 좋습니다. 예를 들어:  
      * 환율 변환(원화 ↔ 달러)  
      * 간단한 세금/수수료 계산  
      * 일정/마감일까지 남은 일수 계산  
    * 이렇게 만들고 나면, Copilot Studio 에이전트에게  
      * "이번 달 카드 사용액에 10% 부가세를 포함한 총액을 계산해 줘."  
      * "다음 주 금요일까지 며칠 남았는지 알려줘."  
      처럼 **업무에 가까운 질문**을 던져보며 MCP의 활용 가능성을 체감할 수 있습니다.

> **Tip:** Tracing 뷰를 항상 켜 둔 상태에서, "질문 → MCP 도구 호출 → 응답 생성" 흐름을 눈으로 따라가면 **에이전트가 도구를 언제, 왜 선택하는지**를 이해하는 데 큰 도움이 됩니다.

---

## 8. 실습 종료 및 환경 정리 (Cleanup)

실습이 완료되면 시스템을 깨끗한 상태로 되돌립니다.

1. VS Code 터미널에서 `Ctrl + C`를 눌러 서버와 ngrok을 종료합니다.
2. 바탕화면의 `McpDemo` 폴더를 **삭제**합니다.
3. 이것으로 설치된 ngrok 프로그램과 가상환경 라이브러리가 시스템에서 완벽하게 제거됩니다.